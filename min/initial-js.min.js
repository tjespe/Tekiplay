var app=angular.module("app",["ngRoute"]);
app.config(["$routeProvider","$sceProvider","$locationProvider","$controllerProvider","$provide","$compileProvider","$filterProvider","$sceDelegateProvider",function(k,f,c,l,g,h,a,p){p.resourceUrlWhitelist(["self","https://script.google.com"]);f.enabled(!0);k.when("/",{templateUrl:"src/views/home.html"}).when("/tag/:category",{templateUrl:"src/views/category.html"}).when("/search/:category",{templateUrl:"src/views/category.html"}).when("/id/:id",{controller:"gameCtrl",controllerAs:"g",templateUrl:"src/views/game.html"}).when("/submit",
{templateUrl:"src/views/submit.html"}).when("/cookies",{templateUrl:"src/views/policy.html"}).when("/contact",{templateUrl:"src/views/contact.html"}).when("/tag",{redirectTo:"/"}).when("/403",{templateUrl:"src/views/error.html"}).when("/401",{templateUrl:"src/views/error.html"}).otherwise({templateUrl:"src/views/error.html"});c.html5Mode(!0);app.controller=function(a,m){l.register(a,m);return this};app.service=function(a,m){g.service(a,m);return this};app.directive=function(a,m){h.directive(a,m);
return this};app.filter=function(b,m){a.register(b,m);return this}}]);app.service("initialJSON",["$http","$lhttp","urls",function(k,f,c){this.pass=encodeURIComponent(window.location.search.slice(1)+window.location.hash.slice(1));this.json=f.get(this.pass.length?"https://script.google.com/macros/s/AKfycbzEVUBnYRqGOFS6309I9Oe748omXUWLjpDScrjYatNvxKuL6BEU/exec?pass="+this.pass:c.initialJSON);this.jquery=f.get("https://code.jquery.com/jquery-2.2.3.min.js",0);this.jquery.then(function(c){eval(c)})}]);
app.directive("script",function(){return{restrict:"E",scope:!1,link:function(k,f,c){"text/javascript-lazy"===c.type&&eval(f[0].text)}}});
app.value("urls",{rating:"https://script.google.com/macros/s/AKfycbzulzGAeSR2eErndxSAUkDi3dXlnmYif0MlkpjnfJsHKVNSMpE/exec",checkIfChanged:"https://script.google.com/macros/s/AKfycbwx-oLuzjUIAPxMxKiiNFgt6Wgb6T4WGO8UguTGu8HCXUBt-SX7/exec",comment:"https://script.google.com/macros/s/AKfycbwK2mif23UU5f9B2NXuvcRT6VajMU7iXQPxRnlKeNtfsD2Eflvz/exec",countGames:"https://script.google.com/macros/s/AKfycbwc3i7zLH3vC8HWnVtBVPqZkv8iOMIlxKZ1E7gL2bdIL8kd9lA/exec",getGames:"https://script.google.com/macros/s/AKfycbxGh5agyHkqBi5KbpYxl9G2gJlR5kuJzjJ--5BaP-KfcgaItx0/exec",
submitGame:"https://script.google.com/macros/s/AKfycbxh_WPU_DKwT3xAxR0BCcjb_wQ4pQG2nspBbpKra94BEYlO4yw/exec",subscribe:"",initialJSON:"/min/initialJSON.json"});
app.service("$lhttp",["$http","$q","$timeout",function(k,f,c){var l=this;l.ldbOn=!0;try{!function(){function c(b,m){return a?void(a.transaction("s").objectStore("s").get(b).onsuccess=function(a){m(a.target.result&&a.target.result.v||null)}):void setTimeout(function(){c(b,m)},100)}var h=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;if(!h)return void console.error("indexDB not supported");var a,f={k:"",v:""};h=h.open("d2",1);h.onsuccess=function(b){a=this.result};
h.onerror=function(a){console.error("indexedDB request error");console.log(a)};h.onupgradeneeded=function(b){a=null;b.target.result.createObjectStore("s",{keyPath:"k"}).transaction.oncomplete=function(b){a=b.target.db}};window.ldb={get:c,set:function(b,c){f.k=b;f.v=c;a.transaction("s","readwrite").objectStore("s").put(f)}}}()}catch(g){console.warn("Unable to use lbd, using localStorage instead. Error:",g),l.ldbOn=!1}l.get=function(g,h,a,p){var b=f.defer();"undefined"===typeof a&&(a={});a.timeout=
b.promise;a=k.get(g,a);a.success(function(a){try{l.ldbOn?ldb.set(g,JSON.stringify(a)):localStorage[g]=JSON.stringify(a)}catch(q){console.log("Couldn't save "+g+"-data to storage. Error:",q)}b.resolve(a)});a.error(function(a,c){try{ldb.get(g,function(a){null!==a?b.resolve(JSON.parse(a)):"undefined"!==typeof localStorage[g]?b.resolve(JSON.parse(localStorage[g])):b.reject("ERROR")})}catch(t){try{"undefined"!==typeof localStorage[g]?b.resolve(JSON.parse(localStorage[g])):b.reject("ERROR")}catch(d){b.reject("ERROR")}}});
"undefined"!==typeof h&&c(function(){l.ldbOn?ldb.get(g,function(a){null!==a?b.resolve(JSON.parse(a)):""}):"undefined"!==typeof Storage&&g in localStorage&&b.resolve(JSON.parse(localStorage[g]))},h);"undefined"!==typeof p&&p["catch"](function(){b.reject("Canceled")});return b.promise}}]);app.controller("masterCtrl",["$http","$window","$rootScope","$routeParams","$scope","$location","$timeout","$injector","$q","initialJSON","$lhttp","urls",function(k,f,c,l,g,h,a,p,b,m,q,t){var d=this;d.request_in_progress=!1;d.query="";d.lang=window.navigator.language.replace(/-.+/g,"");d.availableLangs=["en","es","no"];d.desc="";d.games={"/":[]};d.routeChanged=!1;d.verifiedUser=!1;d.tags=[{name:"Puzzle",amount:470},{name:"Action",amount:334},{name:"Jigsaw Puzzles",amount:315},{name:"Shooting",amount:256},
{name:"HTML5",amount:210},{name:"Racing",amount:202},{name:"Adventure",amount:196}];d.textData={};d.showAllTags=!1;window.location.href.includes("lang=")&&(d.lang=window.location.href.replace(/.+lang=/,""));d.lang="nb"==d.lang||"nn"==d.lang?"no":d.lang;d.lang=-1<d.availableLangs.indexOf(d.lang)?d.lang:"en";m.json.then(function(a){Array.prototype.push.apply(d.games["/"],a.initialGames);d.verifiedUser=a.verifiedUser;d.tags=a.topTags});d.rate=function(a,c){};d.like=function(a){d.rate(a,"like",1)};d.dislike=
function(a){d.rate(a,"dislike",-1)};d.ifDisabled=function(){return d.request_in_progress};d.css="";d.mlcLoaded=!1;d.lazyModulesLoaded=!1;c.$on("$routeChangeSuccess",function(a){try{f.ga("send","pageview",{page:h.url()})}catch(n){}});q.get("min/lazy-js.min.js",2E3).then(function(a){eval(a);d.lazyModulesLoaded=!0});/bot|curl|spider|google|twitter^$/i.test(navigator.userAgent)||q.get("src/js/scripts/analytics.js",0).then(function(a){eval(a)});q.get("src/js/objects/"+d.lang+"-text.json").then(function(a){d.textData=
a})["catch"](function(a,c){console.log(a,c);confirm("Unable to load textdata, do you want to reload the page?")?location.reload(!0):null})}]);app.controller("categoryCtrl",["$http","$routeParams","$scope","urls","initialJSON","$lhttp",function(k,f,c,l,g,h){var a=this,p=!1;a.tag=f.category||"/";a.max_amount=1;a.noGames=!1;c.master.loc="Thorin-Games \u2014 "+("/"!==a.tag?a.tag:c.master.textData.title);c.master.desc="/"!==a.tag?c.master.textData.categoryDescription.replace("{{tag}}",a.tag):c.master.textData.intro;a.games=a.tag in c.master.games?a.games=c.master.games[a.tag]:[];h.get(l.countGames+"?d="+Date.now()+("/"!==a.tag?"&tag="+a.tag:
"")+"&pass="+g.pass,800).then(function(b){a.max_amount=Number(b);var g=c.master.desc;if("/"!==a.tag){var f=" "+c.master.textData.games;c.master.desc=g.substring(0,g.indexOf(f))+" "+b+g.substring(g.indexOf(f))}18<a.max_amount?a.requestGames(18):a.requestGames(a.max_amount);0==a.max_amount&&(a.noGames=!0)});a.requestGames=function(b){if(!p&&!a.allGamesAreDisplayed()){p=!0;var f=a.games.length;f+b>a.max_amount&&(b=a.max_amount-(f+b));b=l.getGames+"?from="+f+"&amount="+b+("/"!==a.tag?"&tag="+a.tag:"")+
"&d="+Date.now()+"&pass="+g.pass;h.get(b,1500).then(function(b){Array.prototype.push.apply(a.games,b.data);p=!1;c.master.games[a.tag]=a.games})}};a.allGamesAreDisplayed=function(){return a.games.length>=a.max_amount}}]);app.controller("gameCtrl",["$scope","$routeParams","$http","$sce","$interval","$timeout","$window","$location","initialJSON","$lhttp","urls",function(k,f,c,l,g,h,a,p,b,m,q){function t(){/^[\d.,]+%$/.test(e.gamedata.height)&&b.jquery.then(function(){$("embed").ready(function(){h($("embed").attr,1E3,!0,"height",$("embed").width()*(Number(e.gamedata.height.split("%")[0])/100)+1)})})}function d(){n=r=!0;c.get(q.getGames+"?id="+f.id+"&pass="+b.pass+"&dt="+Date.now()).success(function(a){e.gamedata.comments=
a.comments;n=r=!1})}var e=this,n=!1,r=!1,u=0;e.ifDisabled=function(){return r};"https:"===location.protocol&&(location.protocol="http:");var w=q.getGames+"?id="+f.id+"&pass="+b.pass;e.gamedata={};e.showRedirectPrompt=!1;m.get(w,1500).then(function(a){e.gamedata=a;k.master.loc="Thorin-Games \u2014 "+a.title;k.master.desc=a.description;a=l.trustAsResourceUrl(e.gamedata.file);"n"===e.gamedata.height&&(e.gamedata.height=.75*window.innerHeight);"r"===e.gamedata.height||"r"===e.gamedata.width?e.showRedirectPrompt=
!0:$("embed").attr("src",a);t()});e.rate=function(a,b){n=r=!0;c.get(q.rating+"?action="+b+"&id="+a).then(function(a){n=r=!1;e.gamedata.likes=a.data})};var x=g(function(){if(n||r)8<u&&(e.gamedata.comments=[{com:"Lost contact with server - trying to reconnect",author:"..."}],n=!1),u++;else{n=!0;var a=q.checkIfChanged+"?d="+Math.floor(Date.now()/1E4)+"&id="+f.id+"&coms="+e.gamedata.comments.length,b=Date.now();c.get(a).then(function(a){n=!1;u=0;JSON.parse(a.data)&&d();for(a=0;a<e.gamedata.comments.length;a++)e.gamedata.comments[a].date||
(e.gamedata.comments[a].date=1459870175813),e.gamedata.comments[a].date+=(Date.now()-b)/1E3})["catch"](function(){n=!1})}},2400);k.$on("$destroy",function(){return g.cancel(x)});try{e.author=localStorage.username}catch(v){e.author=""}e.comment="";e.submit_comment=function(){if(!r&&0<e.comment.length&&0<e.author.length){k.commentForm.$setUntouched();try{localStorage.username=e.author}catch(v){}n=r=!0;c.get(q.comment+"?id="+f.id+"&com="+encodeURIComponent(e.comment)+"&author="+encodeURIComponent(e.author)).then(function(a){n=
r=!1;e.comment="";d()})["catch"](function(){alert("Your message was not submitted.\nPlease try again.");r=n=!1})}else k.commentForm.$setTouched()};e.goBack=function(){return k.master.routeChanged?a.history.back(1):p.path("/")};e.jquery=function(){var a=$("textarea").outerHeight();$("textarea").keyup(function(){$("a.glyphicon[type=submit]").css("line-height",$("form.com-container>div").height()-24+"px");var b=$("textarea").width()*(30/270);b=Math.floor($("textarea").val().length/b)+1;$("textarea").css("height",
b*a+"px");k.view.ifMobile||$("html, body").animate({scrollTop:$(document).height()})});$(window).resize(t)};b.jquery.then(e.jquery);e.ifSpace=function(){return 140<window.innerWidth-document.querySelector("embed").clientWidth&&!k.view.ifMobile}}]);app.controller("viewCtrl",[function(){this.ifMobile="ontouchstart"in window;this.showHeader=function(){return!window.location.href.includes("/id/")}}]);app.directive("paraBack",["$window",function(k){return function(f,c,l){c.css("background-image","url("+l.paraBack+")");c.css("background-attachment","fixed");var g=Infinity,h=new Image;h.src=l.paraBack;h.onload=function(){g=h.height-window.innerHeight;c.css("background-position-x",-(h.width/2-c[0].offsetWidth/2)+"px")};var a=function(){var a=Math.floor(.1*this.pageYOffset);a<g&&c.css("background-position-y","-"+a+"px")};f.view.ifMobile||(angular.element(k).on("scroll",a),f.$on("$destroy",function(){angular.element(k).off("scroll",
a)}))}}]);